<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard UMKM</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background:#f5f5f5; }
h1,h2 { text-align:center; }
.card { background:white; padding:15px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
table { width:100%; border-collapse: collapse; margin-top:10px; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#eee; }
img.nota { width:80px; border-radius:4px; }
.chart-container { width:100%; max-width:800px; margin:0 auto; }
iframe.tally { width:100%; border:none; }
</style>
</head>
<body>

<h1>Dashboard UMKM</h1>

<!-- Ringkasan Keuangan -->
<div class="card">
  <h2>Ringkasan Keuangan</h2>
  <p>Total Pemasukan: <span id="totalPemasukan">0</span></p>
  <p>Total Pengeluaran: <span id="totalPengeluaran">0</span></p>
  <p>Keuntungan Bersih: <span id="keuntunganBersih">0</span></p>
  <p>Prakiraan Pajak (1% omzet): <span id="prakiraanPajak">0</span></p>
</div>

<!-- Tally Form Embed -->
<div class="card">
  <h2>Input Transaksi</h2>
  <iframe class="tally" src="https://tally.so/embed/dWdjgo?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1" height="700"></iframe>
</div>

<!-- Chart Arus Kas -->
<div class="card chart-container">
  <h2>Arus Kas Bulanan</h2>
  <canvas id="arusKasChart" height="100"></canvas>
</div>

<!-- Tabel Transaksi -->
<div class="card">
  <h2>Daftar Transaksi</h2>
  <table id="transaksiTable">
    <thead>
      <tr>
        <th>Tanggal</th>
        <th>Tipe</th>
        <th>Jumlah</th>
        <th>Keterangan</th>
        <th>Nota</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
// ===== LINK CSV GOOGLE SHEETS =====
const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS-qVdnfU6If_Ffkt_RJbIxAbgp1F52ne8t6hf0xkatr1iakkzTS4e_IEta64jpHoHBr0tL5AOsYOQX/pub?output=csv';

// ===== FUNCTION FETCH CSV =====
async function fetchCSV(url) {
  const res = await fetch(url);
  const text = await res.text();
  return text.split('\n').slice(1).map(row => {
    const cols = row.split(',');
    return {
      tanggal: cols[0],
      tipe: cols[1],
      jumlah: parseFloat(cols[2]),
      keterangan: cols[3],
      nota: cols[4]
    };
  });
}

// ===== MAIN =====
fetchCSV(csvUrl).then(dataTransaksi => {
  // ===== Rekap Keuangan =====
  let totalPemasukan = 0, totalPengeluaran = 0;
  dataTransaksi.forEach(t => {
    if(t.tipe==='Pemasukan') totalPemasukan += t.jumlah;
    else totalPengeluaran += t.jumlah;
  });
  const keuntungan = totalPemasukan - totalPengeluaran;
  const pajak = totalPemasukan * 0.01;

  document.getElementById('totalPemasukan').textContent = 'Rp ' + totalPemasukan.toLocaleString();
  document.getElementById('totalPengeluaran').textContent = 'Rp ' + totalPengeluaran.toLocaleString();
  document.getElementById('keuntunganBersih').textContent = 'Rp ' + keuntungan.toLocaleString();
  document.getElementById('prakiraanPajak').textContent = 'Rp ' + pajak.toLocaleString();

  // ===== Tabel Transaksi =====
  const tbody = document.getElementById('transaksiTable').querySelector('tbody');
  dataTransaksi.forEach(t => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${t.tanggal}</td>
      <td>${t.tipe}</td>
      <td>Rp ${t.jumlah.toLocaleString()}</td>
      <td>${t.keterangan}</td>
      <td>${t.nota ? `<a href="${t.nota}" target="_blank"><img src="${t.nota}" class="nota"></a>` : ''}</td>
    `;
    tbody.appendChild(tr);
  });

  // ===== Chart Arus Kas =====
  const ctx = document.getElementById('arusKasChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: dataTransaksi.map(t => t.tanggal),
      datasets: [
        { label:'Pemasukan', data:dataTransaksi.map(t => t.tipe==='Pemasukan'?t.jumlah:0), borderColor:'green', backgroundColor:'rgba(0,255,0,0.1)', fill:true },
        { label:'Pengeluaran', data:dataTransaksi.map(t => t.tipe==='Pengeluaran'?t.jumlah:0), borderColor:'red', backgroundColor:'rgba(255,0,0,0.1)', fill:true }
      ]
    },
    options: { responsive:true, plugins:{legend:{position:'top'}} }
  });
});
</script>

</body>
</html>
